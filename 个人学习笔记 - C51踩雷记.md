# 个人学习笔记 - C51踩雷记

## 目录

- [个人学习笔记 - C51踩雷记](#个人学习笔记---c51踩雷记)
  - [目录](#目录)
  - [前言](#前言)
  - [一、中断](#一中断)
    - [中断与指针](#中断与指针)
  - [二、指针](#二指针)
    - [指针分类](#指针分类)
    - [指针使用](#指针使用)
  - [三、针对使用指针导致代码跑飞出现的复位问题](#三针对使用指针导致代码跑飞出现的复位问题)
    - [问题出现的条件](#问题出现的条件)
    - [解决方案（疑似可解决、需时间验证）](#解决方案疑似可解决需时间验证)
  - [扫码关注](#扫码关注)

## 前言

技术探讨QQ群：[528337130]，[加群备用链接]  
微信公众号：`嵌入式进阶之道`，`XiaoNingEngineer`  
GitHub地址：[小宁GitHub]  
Gitee地址：[小宁Gitee]

[528337130]: <https://jq.qq.com/?_wv=1027&k=yDw5eN6O>
[加群备用链接]: <https://jq.qq.com/?_wv=1027"&"k=yDw5eN6O>
[小宁GitHub]: <https://github.com/Fighting-XiaoNing>
[小宁Gitee]: <https://gitee.com/Fighting-XiaoNing>

## 一、中断

### 中断与指针

1. 当开启中断时，请不要使用任何函数指针、函数指针数组，除非你会看map文件，并且会手动分配变量存储地址；
   > 因为编译器识别不了函数指针，会认为函数指针指向的Fun函数与中断函数不会同时存在，
   > 进而导致中断内a变量与Fun函数内b变量被分配到同一个地址，且不会进行压栈操作，
   > Fun运行中被中断打断，中断内改变变量a，退出中断后继续运行Fun，此时变量b已经被意外改变了；
2. 当使用中断后，不要使用回调函数，回调函数本质也是函数指针

## 二、指针

### 指针分类

| 类型    | 释义     | 长度                                  | 注释        |
| ------- | ------- | ------------------------------------- | ---------- |
| *       | 通用指针 | 3字节（数据类型、地址高位、地址低位）    | 指向任何段  |
| code *  | 特殊指针 | 2字节（地址高位、地址低位）             | 指向code段  |
| xdata * | 特殊指针 | 2字节（地址高位、地址低位）             | 指向xdata段 |
| data *  | 特殊指针 | 1字节（地址低位）                      | 指向data段  |
| idata * | 特殊指针 | 1字节（地址低位）                      | 指向idata段 |
| pdata * | 特殊指针 | 1字节（地址低位）                      | 指向pdata段 |

### 指针使用

```C
uint8_t *p = NULL;              // 通用指针，指针指向位置未知，指针存储位置未知，长度3字节
uint8_t xdata * idata p = NULL; // 指向xdata段uint8_t类型数据，指针存储在idata段，长度2字节
```

> 局部指针uint8_t *p = NULL;有中断，有函数指针，
> 此时虽为ptr3，但不知道为什么默认指向idata，再指向xdata就出错

## 三、针对使用指针导致代码跑飞出现的复位问题

### 问题出现的条件

> `Memory Model`选择：Large: variables in XDATA
> `Level`选择：优化等级≠0
> `指针变量`（包括存有函数名、函数指针的指针数组）

### 解决方案（疑似可解决、需时间验证）

1. 方案1：优化等级设置0（关闭优化）
2. 方案2：打开启动文件`STARTUP.A51`，将`IDATALEN`与`XDATALEN`改为芯片实际大小

## 扫码关注

| QQ群二维码                 |   | 微信公众号二维码                     |
| :-----------------------: |---| :---------------------------------: |
| ![QQ群](./Other/QQ群.png) |   | ![微信公众号](./Other/微信公众号.jpg) |
